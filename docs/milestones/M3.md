# Milestone Design Document

**Milestone:** M3 â€” Artifact and Experiment Tracking Infrastructure

## Scope

M3 provides the infrastructure for tracking experiments, logging metrics, and managing artifact lineage across the Formula Foundry pipeline. It integrates MLflow with the existing substrate artifact store to enable:

- Reproducible experiment tracking with SQLite backend
- Unified logging of parameters, metrics, and tags
- Artifact reference linking (avoiding duplication)
- Integration with substrate manifest and determinism infrastructure

## Normative Requirements (must)

- [REQ-M3-001] MLflow configuration must use SQLite backend store at `data/mlflow/mlruns.db`
- [REQ-M3-002] Local artifact root must be configured at `data/mlflow/artifacts`
- [REQ-M3-003] Tracker must log substrate manifest data (git_sha, design_doc_sha256, environment_fingerprint, determinism_mode)
- [REQ-M3-004] Run wrapper must support linking to substrate RunArtifacts
- [REQ-M3-005] Artifact references must be logged as JSON files (not duplicated)
- [REQ-M3-006] Configuration must be loadable from `config/mlflow.yaml`
- [REQ-M3-007] Tracker must operate in no-op mode when MLflow is not installed

## Definition of Done

- MLflow configuration file exists at `config/mlflow.yaml` with SQLite backend
- Tracking module exists at `src/formula_foundry/tracking/`
- Config loader parses YAML and provides typed access to configuration
- Run wrapper integrates MLflow with substrate manifest and artifact store
- Unit tests verify configuration loading and run wrapper behavior
- Documentation describes experiment tracking workflow

## Test Matrix

| Requirement | Pytest(s) |
|---|---|
| REQ-M3-001 | tests/tracking/test_config.py::test_backend_store_uri |
| REQ-M3-002 | tests/tracking/test_config.py::test_artifact_root |
| REQ-M3-003 | tests/tracking/test_logger.py::test_log_manifest |
| REQ-M3-004 | tests/tracking/test_logger.py::test_run_artifacts_linkage |
| REQ-M3-005 | tests/tracking/test_logger.py::test_artifact_reference |
| REQ-M3-006 | tests/tracking/test_config.py::test_load_config |
| REQ-M3-007 | tests/tracking/test_logger.py::test_noop_without_mlflow |
