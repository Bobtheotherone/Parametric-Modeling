# Milestone Design Document

**Milestone:** M2 â€” openEMS FDTD Simulation Environment

## Scope

This milestone establishes the deterministic FDTD simulation environment using openEMS.
It enables:
- Reproducible EM simulations via pinned openEMS toolchain
- Docker-containerized execution with CPU and GPU support
- Configurable mesh generation for via-transition coupon geometries
- Simulation spec schema for defining FDTD parameters

## Normative Requirements (must)

- [REQ-M2-001] **Pin openEMS version**: The openEMS toolchain version MUST be pinned
  in `config/openems_toolchain.json` with a digest-pinned Docker image reference
  (format: `image:tag@sha256:<digest>`). The pinned version is `0.0.35`.

- [REQ-M2-002] **Docker with CPU+GPU support**: The Dockerfile at `tools/m2/docker/Dockerfile`
  MUST build openEMS 0.0.35 with CPU support (MPI-enabled). GPU acceleration MUST be
  available via docker-compose profile (`--profile gpu`) using NVIDIA Container Toolkit.

- [REQ-M2-003] **Mesh generation parameters**: The `MeshSpec` schema MUST support:
  - `lambda_resolution`: cells per wavelength at max frequency (default: 20, range: 10-100)
  - `metal_edge_resolution_nm`: max cell size near metal edges (default: 50,000 nm)
  - `via_resolution_nm`: max cell size near via barrels (default: 25,000 nm)
  - Fixed mesh lines in x/y/z dimensions

- [REQ-M2-004] **Simulation spec schema**: `SimulationSpec` MUST define all parameters
  for deterministic FDTD simulation including toolchain, geometry reference, excitation,
  frequency sweep, boundaries, mesh, ports, materials, and output configuration.

- [REQ-M2-005] **Installation verification**: The `OpenEMSRunner` MUST provide a
  `version_metadata()` method that probes openEMS version and returns structured
  metadata including `openems_version` and `csxcad_version`.

## Definition of Done

- `config/openems_toolchain.json` contains pinned version 0.0.35 with sha256 digest
- `tools/m2/docker/Dockerfile` builds successfully with CPU support
- `tools/m2/docker/docker-compose.yml` defines both CPU and GPU service profiles
- `tools/m2/docker/README.md` documents GPU passthrough requirements
- All `test_m2_openems_*.py` tests pass
- Schema validates mesh resolution, port definitions, and boundary conditions

## Test Matrix

| Requirement | Pytest(s) |
|---|---|
| REQ-M2-001 | tests/test_m2_openems_toolchain.py::test_openems_toolchain_pins_container_digest |
| REQ-M2-002 | (Docker build verification - manual or CI) |
| REQ-M2-003 | tests/test_m2_openems_schema.py::TestMeshSpec |
| REQ-M2-004 | tests/test_m2_openems_schema.py::TestSimulationSpecValidation |
| REQ-M2-005 | tests/test_m2_openems_runner.py::test_openems_runner_version_metadata |
